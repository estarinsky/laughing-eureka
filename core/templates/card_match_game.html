{% extends 'base.html' %}

{% block title %}Card Match Game{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4">Match the Words</h2>
        <div>
            <button id="start-daily-challenge-btn" class="btn btn-warning">Start Daily Challenge</button>
            <button id="reset-daily-challenge-btn" class="btn btn-danger">Reset</button>
            <span class="h5 ms-3">Matches Found: <span id="matches-count" class="badge bg-primary">0</span> / <span id="total-pairs">{{ total_pairs }}</span></span>
        </div>
    </div>
    <div class="h5 mb-3">Daily challenge games left: <span id="daily-challenge-games">5</span></div>

    {% if error %}
    <div class="alert alert-danger">
        <p class="fw-bold">Error</p>
        <p>{{ error }}</p>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="text-center text-primary">Ελληνικά (Greek)</h3>
                    <div class="list-group" id="greek-cards">
                        {% for card in greek_cards %}
                        <button type="button" class="list-group-item list-group-item-action game-card greek-card"
                                data-id="{{ card.id }}" data-pair-id="{{ card.pair_id }}" data-type="greek">
                            {{ card.text }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-6">
                    <h3 class="text-center text-success">Русский (Russian)</h3>
                    <div class="list-group" id="russian-cards">
                        {% for card in russian_cards %}
                        <button type="button" class="list-group-item list-group-item-action game-card russian-card"
                                data-id="{{ card.id }}" data-pair-id="{{ card.pair_id }}" data-type="russian">
                            {{ card.text }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="success-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Congratulations!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>You've matched all the pairs!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="location.reload()">Play Again</button>
            </div>
        </div>
    </div>
</div>

<style>
    .game-card.selected {
        background-color: #e0e7ff;
        border-color: #4f46e5;
    }
    .game-card.matched {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #d1fae5;
        border-color: #10b981;
    }
    .game-card.incorrect {
        animation: incorrect-match 0.5s ease;
        border-color: #ef4444;
    }
    @keyframes incorrect-match {
        0%, 100% { transform: translateX(0); }
        20% { transform: translateX(-10px); }
        40% { transform: translateX(10px); }
        60% { transform: translateX(-10px); }
        80% { transform: translateX(10px); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const matchesCountSpan = document.getElementById('matches-count');
    const totalPairsSpan = document.getElementById('total-pairs');
    const successModal = new bootstrap.Modal(document.getElementById('success-modal'));
    const startDailyChallengeBtn = document.getElementById('start-daily-challenge-btn');
    const resetDailyChallengeBtn = document.getElementById('reset-daily-challenge-btn');
    const dailyChallengeGamesSpan = document.getElementById('daily-challenge-games');
    let cards = document.querySelectorAll('.game-card');

    let selectedGreek = null;
    let selectedRussian = null;
    let matchedPairs = 0;
    let lockBoard = false;
    let totalPairs = parseInt("{{ total_pairs }}", 10) || 0;
    const isDailyChallenge = new URLSearchParams(window.location.search).has('daily_challenge');

    const DAILY_CHALLENGE_GAMES = 5;

    function updateGamesDisplay(games) {
        dailyChallengeGamesSpan.textContent = games;
    }

    function getDailyChallengeData() {
        const data = localStorage.getItem('dailyCardMatchChallenge');
        if (data) {
            const parsedData = JSON.parse(data);
            const today = new Date().toISOString().slice(0, 10);
            if (parsedData.date === today) {
                return parsedData;
            }
        }
        const newData = { date: new Date().toISOString().slice(0, 10), games: DAILY_CHALLENGE_GAMES };
        localStorage.setItem('dailyCardMatchChallenge', JSON.stringify(newData));
        return newData;
    }

    function updateDailyChallengeData(games) {
        const today = new Date().toISOString().slice(0, 10);
        const data = { date: today, games: games };
        localStorage.setItem('dailyCardMatchChallenge', JSON.stringify(data));
    }

    let dailyChallengeData = getDailyChallengeData();
    updateGamesDisplay(dailyChallengeData.games);

    startDailyChallengeBtn.addEventListener('click', () => {
        if (dailyChallengeData.games > 0) {
            window.location.href = "{% url 'card_match_game' %}?daily_challenge=true";
        } else {
            alert("You have no more daily challenge games today.");
        }
    });

    resetDailyChallengeBtn.addEventListener('click', () => {
        const newData = { date: new Date().toISOString().slice(0, 10), games: DAILY_CHALLENGE_GAMES };
        localStorage.setItem('dailyCardMatchChallenge', JSON.stringify(newData));
        dailyChallengeData = newData;
        updateGamesDisplay(dailyChallengeData.games);
    });

    cards.forEach(card => card.addEventListener('click', () => selectCard(card)));

    function selectCard(card) {
        if (lockBoard || card.classList.contains('matched')) return;

        const cardType = card.dataset.type;

        if (cardType === 'greek') {
            if (selectedGreek) {
                selectedGreek.classList.remove('selected');
            }
            selectedGreek = card;
            selectedGreek.classList.add('selected');
        } else if (cardType === 'russian') {
            if (selectedRussian) {
                selectedRussian.classList.remove('selected');
            }
            selectedRussian = card;
            selectedRussian.classList.add('selected');
        }

        if (selectedGreek && selectedRussian) {
            lockBoard = true;
            checkForMatch();
        }
    }

    function checkForMatch() {
        const isMatch = selectedGreek.dataset.pairId === selectedRussian.dataset.pairId;
        const wordIdToUpdate = selectedGreek.dataset.id;

        if (isMatch) {
            handleCorrectMatch();
            updateScore(wordIdToUpdate, true);
        } else {
            handleIncorrectMatch();
            updateScore(wordIdToUpdate, false);
        }
    }

    function handleCorrectMatch() {
        selectedGreek.classList.remove('selected');
        selectedRussian.classList.remove('selected');

        selectedGreek.classList.add('matched');
        selectedRussian.classList.add('matched');

        matchedPairs++;
        matchesCountSpan.textContent = matchedPairs;

        if (matchedPairs === totalPairs && totalPairs > 0) {
            if (isDailyChallenge) {
                dailyChallengeData.games--;
                updateDailyChallengeData(dailyChallengeData.games);
                updateGamesDisplay(dailyChallengeData.games);
            }
            setTimeout(() => {
                successModal.show();
            }, 500);
        }

        resetSelection();
    }

    function handleIncorrectMatch() {
        selectedGreek.classList.add('incorrect');
        selectedRussian.classList.add('incorrect');

        setTimeout(() => {
            selectedGreek.classList.remove('selected', 'incorrect');
            selectedRussian.classList.remove('selected', 'incorrect');
            resetSelection();
        }, 800);
    }

    function resetSelection() {
        selectedGreek = null;
        selectedRussian = null;
        lockBoard = false;
    }

    function updateScore(wordId, success) {
        fetch("{% url 'update_score' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                word_id: wordId,
                success: success
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error(`Failed to update score: ${data.message}`);
            }
        })
        .catch(error => console.error('Error during fetch operation:', error));
    }
});
</script>

{% endblock %}